version: '3'

services:

  # HTTP API
  # Restify Node public web API service.
  # 
  # PORTS
  # http : 8080
  #
  api:
    restart: always
    image: chainpoint/node-api-service
    container_name: api
    build:
      context: ./node-api-service
    ports:
      - "8080:8080"
    depends_on:
      - rabbitmq
    networks:
      - front-end

  # Splitter
  # Consume batches of incoming hashes from 'api' and re-queue them individually.
  # 
  # PORTS
  # none
  #
  splitter:
    restart: always
    image: chainpoint/node-splitter-service
    container_name: splitter
    build:
      context: ./node-splitter-service
    depends_on:
      - rabbitmq
    networks:
      - back-end

  # Aggregator
  # Aggregate individual hashes into a Merkle tree
  # sending the Merkle root to the `calendar` service, and
  # partial proof data to the `proof-state` service.
  # 
  # PORTS
  # none
  #
  aggregator:
    restart: always
    image: chainpoint/node-aggregator-service
    container_name: aggregator
    build:
      context: ./node-aggregator-service
    depends_on:
      - rabbitmq
    networks:
      - back-end

  # Calendar
  # Aggregate Merkle roots from the `aggregator` service instances
  # and write them to the Calendar event/block chains.
  # 
  # PORTS
  # none
  #
  calendar:
    restart: always
    image: chainpoint/node-calendar-service
    container_name: calendar
    build:
      context: ./node-calendar-service
    depends_on:
      - rabbitmq
    networks:
      - back-end

  # Bitcoin Transmit
  # Send Calendar Block Merkle roots to be embedded in a BTC transaction.
  # 
  # PORTS
  # none
  #
  btc-tx:
    restart: always
    image: chainpoint/node-btc-tx-service
    container_name: btc-tx
    build:
      context: ./node-btc-tx-service
    depends_on:
      - rabbitmq
    networks:
      - back-end

  # Proof State
  # Encapsulates all persistent data storage for partial proof data.
  # 
  # PORTS
  # none
  #
  proof-state:
    restart: always
    image: chainpoint/node-proof-state-service
    container_name: proof-state
    build:
      context: ./node-proof-state-service
    depends_on:
      - rabbitmq
    networks:
      - back-end

  # Proof Generation
  # Responsible for constructing, signing, and validating Chainpoint proofs
  # for Calendar, Bitcoin, and Ethereum attestation levels.
  # 
  # PORTS
  # none
  #
  proof-gen:
    restart: always
    image: chainpoint/node-proof-gen-service
    container_name: proof-gen
    build:
      context: ./node-proof-gen-service
    depends_on:
      - rabbitmq
    networks:
      - back-end

  # RabbitMQ
  #
  # Realtime Admin Page (username:pass)
  # http://127.0.0.1:15672/ (rabbitmq:rabbitmq)
  #
  # PORTS:
  # amqp : 5672
  # http : 15672
  #
  rabbitmq:
    restart: always
    image: "rabbitmq:3.6.9-management-alpine"
    hostname: rabbitmq
    container_name: rabbitmq
    ports:
    - 5672:5672
    - 15672:15672
    environment:
    - RABBITMQ_DEFAULT_USER=chainpoint
    - RABBITMQ_DEFAULT_PASS=chainpoint
    networks:
      - back-end
      - front-end

  # Redis
  #
  # PORTS:
  # redis : 6379
  #
  redis:
    restart: always
    image: "redis:3.2.8-alpine"
    container_name: redis
    networks:
      - back-end

  crate1:
    restart: always
    image: crate:1.1.2
    container_name: crate-01
    ports:
      - "4200:4200"
      - "4300:4300"
    volumes:
      - /tmp/data/crate:/data
    environment:
      CRATE_HEAP_SIZE: 4g
    command: crate -Cpath.conf=/crate/config -Ccluster.name=cluster -Ccluster.routing.allocation.disk.watermark.high=500mb -Ccluster.routing.allocation.disk.threshold_enabled=false
    networks:
      - back-end

  crate2:
    restart: always
    image: crate:1.1.2
    container_name: crate-02
    volumes:
      - /tmp/data/crate:/data
    environment:
      CRATE_HEAP_SIZE: 4g
    command: crate -Cpath.conf=/crate/config -Ccluster.name=cluster -Ccluster.routing.allocation.disk.watermark.high=500mb -Ccluster.routing.allocation.disk.threshold_enabled=false
    networks:
      - back-end

# Networks
#
# Front end network
#   Shared by HTTP API service and RabbitMQ only.
#
# Back end network
#   Available to all services except HTTP API
#
networks:
  front-end:
    driver: bridge
  back-end:
    driver: bridge
